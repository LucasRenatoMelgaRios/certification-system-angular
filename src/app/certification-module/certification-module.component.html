<div class="cert-module">
  <div class="cert-header">
    <h2>PLANTILLAS DE CERTIFICADOS GUARDADOS</h2>
    <div class="cert-selection">
      <div 
        *ngFor="let cert of certTemplates" 
        class="cert-template" 
        [class.active]="selectedCert?.id === cert.id" 
        (click)="selectTemplate(cert)"
      >
        <div class="cert-template-preview">
          <img [src]="cert.imageUrl" [alt]="cert.name" />
        </div>
        <span>{{ cert.name }}</span>
      </div>
    </div>
  </div>

  <div class="cert-content">
    <div class="left-panel">
      <div class="signature-section">
        <h4>Sellos del certificado</h4>
        <div class="signatures-list">
          <div *ngFor="let sig of signatures; let i = index" class="signature-item">
            <div class="signature-header">
              <span>Firma {{ i + 1 }}</span>
              <button class="remove-signature" (click)="removeSignature(i)">
                <lucide-icon name="trash-2"></lucide-icon>
              </button>
            </div>
            <img [src]="sig.dataURL" alt="Firma preview" class="signature-preview" />
          </div>
        </div>
        <div class="signature-upload">
          <input 
            type="text" 
            [(ngModel)]="newSignatureLabel" 
            placeholder="Nombre del sello"
            class="signature-label-input"
          />
          <file-pond
            #signaturePond
            [options]="signatureUploadOptions"
            (onupdatefiles)="handleFileUpload($event)"
          ></file-pond>
        </div>
        <button 
          class="generate-button"
          (click)="handleGenerateItems()"
          [disabled]="signatures.length === 0"
        >
          Generar items
        </button>
      </div>

      <div class="drop-zones-control">
        <h4>Zonas de colocación</h4>
        <div class="drop-zones-list">
          <div *ngFor="let zone of dropZones" class="drop-zone-item">
            <span>{{ zone.label }}</span>
            <div class="drop-zone-actions">
              <button (click)="handleRemoveDropZone(zone.id)">
                <lucide-icon name="trash-2"></lucide-icon>
              </button>
            </div>
          </div>
        </div>
        
        <div *ngIf="isAddingDropZone" class="add-drop-zone-form">
          <input
            type="text"
            placeholder="Nombre de la zona"
            [(ngModel)]="newDropZoneLabel"
          />
          <div class="drop-zone-form-actions">
            <button (click)="handleAddDropZone()">Agregar</button>
            <button (click)="isAddingDropZone = false">Cancelar</button>
          </div>
        </div>
        
        <button 
          *ngIf="!isAddingDropZone"
          class="add-drop-zone-button"
          (click)="isAddingDropZone = true"
        >
          <lucide-icon name="circle-plus"></lucide-icon>
          Agregar zona
        </button>
        
        <div class="drag-instructions">
          <p>Haz clic en una zona y usa las flechas del teclado para moverla</p>
          <p>Mantén presionado Shift + flechas para movimientos más grandes</p>
        </div>
      </div>
    </div>

    <div class="certificate-preview" #certificateContainerRef>
      <h3>{{ certificados[0].tipo === 'diplomado' ? 'DIPLOMADO' : 'CERTIFICADO' }}</h3>
      <div *ngIf="certificados[0]?.tipo === 'diplomado'" class="template-view-controls">
        <button 
          (click)="showFrontTemplate()"
          [class.active]="currentTemplateView === 'front'"
        >
          Vista Frontal
        </button>
        <button 
          (click)="showBackTemplate()"
          [class.active]="currentTemplateView === 'back'"
        >
          Vista Trasera
        </button>
      </div>
      <div 
        class="certificate-content" 
        [style.width.px]="certSize.width"
        [style.height.px]="certSize.height"
      >
      <div 
      class="certificate-background" 
      #certificateRef
      [style.backgroundImage]="'url(' + (getCurrentTemplate()?.imageUrl || '') + ')'"
      [style.width.px]="certSize.width"
      [style.height.px]="certSize.height"
    ></div>
        
        <div 
          *ngFor="let zone of dropZones" 
          class="drop-zone"
          [class.selected]="selectedElement && selectedElement.type === 'dropZone' && selectedElement.id === zone.id"
          [class.drop-zone-active]="isDraggedOver(zone.label)"
          [style.left.px]="zone.position.x"
          [style.top.px]="zone.position.y"
          (mousedown)="startDraggingZone($event, zone)"
          (click)="handleSelectElement('dropZone', zone.id)"
        >
          <ng-container [style.color]="getDroppedItem(zone.label)?.color || 'black'" *ngIf="isItemDroppedInZone(zone.label); else placeholder">
            <img 
              *ngIf="getDroppedItem(zone.label)?.type === 'signature'" 
              [src]="getSignatureUrl(getDroppedItem(zone.label)?.signatureIndex)" 
              alt="Firma" 
              class="signature-preview" 
            />
            <span *ngIf="getDroppedItem(zone.label)?.type !== 'signature'">
              {{ getDroppedItem(zone.label)?.text }}
            </span>
          </ng-container>
          <ng-template #placeholder>
            <span class="drop-placeholder">{{ zone.label }}</span>
          </ng-template>
          
          <div class="drop-zone-controls">
            <button class="control-button delete" (click)="$event.stopPropagation(); handleRemoveDropZone(zone.id)">
              <lucide-icon name="trash-2"></lucide-icon>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="items-section">
      <h3>ITEMS GENERADOS</h3>
      <div class="color-controls" *ngIf="selectedElement?.type === 'item' && selectedElementIsText()">
        <span class="color-label">Color de texto:</span>
        <button 
          (click)="changeTextColor('black')"
          [class.active]="textColor === 'black'"
          class="color-button black"
          title="Texto negro"
        ></button>
        <button 
          (click)="changeTextColor('white')"
          [class.active]="textColor === 'white'"
          class="color-button white"
          title="Texto blanco"
        ></button>
      </div>
      <div class="items-container">
        <div 
          *ngFor="let item of generatedItems" 
          class="draggable-item"
          [style.color]="item.color || 'black'"
          [class.selected]="selectedElement && selectedElement.type === 'item' && selectedElement.id === item.id"
          [class.dragging]="draggingItem?.id === item.id"
          (mousedown)="startDraggingItem($event, item)"
          (click)="handleSelectElement('item', item.id)"
          [style.fontSize.px]="20"
          [style.fontWeight]="'bold'"
          tabindex="0"
        >
          {{ item.type === 'signature' ? 'Firma ' + (item.signatureIndex! + 1) : item.text }}
        </div>
        <p *ngIf="generatedItems.length === 0" class="no-items">
          Genera los items para arrastrar al certificado
        </p>
      </div>
    </div>
  </div>
  
  <div class="cert-footer">
    <button 
      class="export-button" 
      (click)="handleExportPDF()"
      [disabled]="!hasDroppedItems()"
    >
      Exportar {{ certificados[0].tipo === 'diplomado' ? 'Diplomado' : 'Certificado' }} PDF
    </button>
  </div>
</div>